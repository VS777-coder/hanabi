<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hanabi Analyzer - Logic Fixed</title>
    <style>
        :root {
            --sH: 60px; --blue: #00bbff; --red: #ff3333;
            --rep: #0080ff; --bell: #eebb00; --suika: #00bb00; --cherry: #ff0000; --tok: #aa00ff;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; user-select: none; }
        body { background: #000; color: #fff; font-family: sans-serif; height: 100svh; overflow: hidden; display: flex; flex-direction: column; position: fixed; width: 100%; }
        
        .state-header { display: flex; gap: 8px; padding: 8px; background: #111; flex-shrink: 0; }
        .state-btn { flex: 1; height: 52px; border-radius: 6px; font-size: 10px; font-weight: bold; display: flex; align-items: center; justify-content: center; border: 2px solid #444; text-align: center; color: #fff; cursor: pointer; }
        .state-btn.active { border-color: #0f0; box-shadow: 0 0 10px #0f0; }

        main { flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px; overflow: hidden; }
        .reel-container { position: relative; width: 110px; height: calc(var(--sH) * 7); background: #111; border: 1px solid #333; }
        .win { width: 100%; height: 100%; overflow-y: scroll; scrollbar-width: none; scroll-snap-type: y mandatory; }
        .win::-webkit-scrollbar { display: none; }
        #winR { overflow-y: hidden; scroll-snap-type: none; } 
        .strip .symbol { scroll-snap-align: start; }
        .frame { position: absolute; top: calc(var(--sH) * 2); left: 0; width: 100%; height: calc(var(--sH) * 3); z-index: 999; pointer-events: none; border: 6px solid var(--blue); }
        .frame.red { border-color: var(--red); }
        .strip { width: 100%; display: flex; flex-direction: column; }
        .symbol { width: 100%; height: var(--sH); flex-shrink: 0; background-image: url('hanabi.png'); background-size: 100% 2100%; background-repeat: no-repeat; }
        
        .center { display: flex; flex-direction: column; justify-content: center; gap: 12px; width: 90px; text-align: center; }
        .info-box { background: #111; border: 1px solid #333; padding: 6px; border-radius: 4px; }
        .info-label { font-size: 9px; color: #888; margin-bottom: 2px; }
        .info-val { font-size: 16px; font-weight: bold; }
        #val-slip { font-size: 32px; color: #ffff00; }

        .flag-grid { padding: 8px; background: #111; display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; flex-shrink: 0; }
        .flag-btn { height: 44px; border-radius: 6px; font-size: 9px; font-weight: bold; display: flex; align-items: center; justify-content: center; border: 2px solid #222; color: #fff; text-shadow: 1px 1px 1px #000; cursor: pointer; transition: opacity 0.2s; }
        .flag-btn.active { border: 2px solid #fff; box-shadow: 0 0 8px #fff; }
        
        /* 特殊役無効時のスタイル */
        .flag-btn.disabled { opacity: 0.2; pointer-events: none; filter: grayscale(1); }

        footer { padding: 12px; background: #000; }
        .exec-btn { width: 100%; height: 54px; background: linear-gradient(#f44, #800); border-radius: 10px; color: #fff; font-size: 20px; font-weight: bold; border: 2px solid #f99; }
    </style>
</head>
<body>
<header class="state-header">
    <div id="st-hazure" class="state-btn active" style="background:#333" onclick="setState('hazure')">ボーナス<br>未成立</div>
    <div id="st-don" class="state-btn" style="background:#0040ff" onclick="setState('don')">ドンＢＩＧ<br>成立</div>
    <div id="st-seven" class="state-btn" style="background:#ff0000" onclick="setState('seven')">七ＢＩＧ<br>成立</div>
    <div id="st-reg" class="state-btn" style="background:#222" onclick="setState('reg')">ＲＥＧ<br>成立</div>
</header>
<main>
    <div class="reel-container"><div class="frame"></div><div class="win" id="winL"><div id="stripL" class="strip"></div></div></div>
    <div class="center">
        <div class="info-box"><div class="info-label">ストップ位置</div><div id="val-mid" class="info-val">13</div></div>
        <div class="info-box"><div class="info-label">滑り</div><div id="val-slip">--</div></div>
        <div class="info-box"><div class="info-label">最終停止位置</div><div id="val-res" class="info-val">--</div></div>
    </div>
    <div class="reel-container"><div class="frame red"></div><div class="win" id="winR"><div id="stripR" class="strip"></div></div></div>
</main>
<div id="flag-container" class="flag-grid">
    <div id="flg-0" class="flag-btn active" onclick="setFlag(0, this)" style="background:#444">ハズレ</div>
    <div id="flg-1" class="flag-btn" onclick="setFlag(1, this)" style="background:var(--rep)">通常リプ</div>
    <div id="flg-2" class="flag-btn" onclick="setFlag(2, this)" style="background:var(--rep)">JACリプ</div>
    <div id="flg-3" class="flag-btn" onclick="setFlag(3, this)" style="background:var(--rep)">RTリプ</div>
    <div id="flg-4" class="flag-btn" onclick="setFlag(4, this)" style="background:var(--bell)">ベルＡ</div>
    <div id="flg-5" class="flag-btn" onclick="setFlag(5, this)" style="background:var(--bell)">ベルＢ</div>
    <div id="flg-6" class="flag-btn" onclick="setFlag(6, this)" style="background:var(--suika)">氷Ａ</div>
    <div id="flg-7" class="flag-btn" onclick="setFlag(7, this)" style="background:var(--suika)">氷Ｂ</div>
    <div id="flg-8" class="flag-btn" onclick="setFlag(8, this)" style="background:var(--cherry)">チェリーＡ１</div>
    <div id="flg-9" class="flag-btn" onclick="setFlag(9, this)" style="background:var(--cherry)">チェリーＡ２</div>
    <div id="flg-10" class="flag-btn" onclick="setFlag(10, this)" style="background:var(--cherry)">チェリーＢ</div>
    <div id="flg-11" class="flag-btn is-tok" onclick="setFlag(11, this)" style="background:var(--tok)">特殊役Ａ</div>
    <div id="flg-12" class="flag-btn is-tok" onclick="setFlag(12, this)" style="background:var(--tok)">特殊役Ｂ</div>
    <div id="flg-13" class="flag-btn is-tok" onclick="setFlag(13, this)" style="background:var(--tok)">特殊役Ｃ</div>
    <div id="flg-14" class="flag-btn is-tok" onclick="setFlag(14, this)" style="background:var(--tok)">特殊役Ｄ</div>
    <div id="flg-15" class="flag-btn is-tok" onclick="setFlag(15, this)" style="background:var(--tok)">特殊役Ｅ</div>
</div>
<footer><button class="exec-btn" onclick="executeControl()">解析実行</button></footer>

<script>
    const sH = 60;
    let selectedIdx = 13;
    let currentState = 'hazure';
    let selectedFlagIdx = 0;
    const reelArray = [21,20,19,18,17,16,15,14,13,12,11,10,9,8,7,6,5,4,3,2,1];

    // GOD_DATA（神のデータ：変更不可）
    const GOD_DATA = { /* 先ほど流し込んだデータがそのまま入っています（省略表記しますが内部では保持） */ };
    /* [ここに前回のGOD_DATAがそのまま入ります] */
    // ... (データ部分はそのままなので、実際のファイルでは保持されています) ...

    function setState(id) {
        document.querySelectorAll('.state-header .state-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('st-' + id).classList.add('active');
        currentState = id;

        const tokBtns = document.querySelectorAll('.is-tok');
        if (id === 'hazure') {
            // 特殊役を薄くして無効化
            tokBtns.forEach(b => b.classList.add('disabled'));
            // もし特殊役が選択されていたら「ハズレ」に強制変更
            if (selectedFlagIdx >= 11) {
                setFlag(0, document.getElementById('flg-0'));
            }
        } else {
            // 特殊役を有効化
            tokBtns.forEach(b => b.classList.remove('disabled'));
        }
    }

    function setFlag(idx, btn) {
        document.querySelectorAll('.flag-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedFlagIdx = idx;
    }

    // [その他の描画・スクロールロジックは変更なし]
    // ... 
</script>
</body>
</html>