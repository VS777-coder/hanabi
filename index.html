<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hanabi Analyzer Pro - Fixed Logic</title>
    <style>
        :root {
            --reel-w: 130px; 
            --sym-h: calc(100vh / 19); /* 7コマが最適に収まる比率 */
            --red: #ff3333; --blue: #3399ff; --green: #22cc22; --yellow: #ffff00; --purple: #cc33ff;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        body { background: #000; color: #fff; font-family: sans-serif; height: 100svh; overflow: hidden; display: flex; flex-direction: column; }

        /* 状態選択 */
        .state-header { display: flex; gap: 4px; padding: 6px; background: #111; z-index: 100; }
        .state-btn { flex: 1; height: 40px; border-radius: 4px; font-size: 11px; font-weight: bold; display: flex; align-items: center; justify-content: center; border: 2px solid #444; }
        .state-btn.active { border-color: #0f0; box-shadow: 0 0 8px #0f0; }
        .st-hazure { background: #333; color: #fff; }
        .st-don { background: #0040ff; color: #fff; }
        .st-seven { background: #ff0000; color: #fff; }
        .st-reg { background: #222; color: #fff; border: 1px solid #666; }

        /* メインレイアウト */
        main { flex: 1; display: flex; align-items: center; justify-content: center; gap: 4px; background: #000; }
        .reel-window { width: var(--reel-w); height: calc(var(--sym-h) * 7); background: #fff; overflow: hidden; position: relative; border: 2px solid #333; }
        .strip { width: 100%; position: absolute; left: 0; transition: transform 0.1s ease-out; }
        .symbol { width: 100%; height: var(--sym-h); background-image: url('hanabi.png'); background-size: 100% 2100%; }

        /* 中央情報 */
        .center-info { display: flex; flex-direction: column; justify-content: space-around; height: calc(var(--sym-h) * 5); width: 90px; background: #111; border: 1px solid #333; }
        .info-box { text-align: center; padding: 4px 0; }
        .info-label { font-size: 10px; color: #aaa; margin-bottom: 2px; }
        .info-val { font-size: 22px; font-weight: bold; color: #fff; }
        .val-slip { color: var(--yellow); font-size: 32px; }

        /* 枠線（太く） */
        .frame-blue { position: absolute; top: calc(var(--sym-h) * 2); width: 100%; height: calc(var(--sym-h) * 3); border: 6px solid var(--blue); z-index: 10; pointer-events: none; }
        .frame-red { position: absolute; top: calc(var(--sym-h) * 2); width: 100%; height: calc(var(--sym-h) * 3); border: 6px solid var(--red); z-index: 10; pointer-events: none; }

        /* 役ボタン */
        .flag-grid { padding: 5px; background: #1a1a1a; display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; max-height: 38%; overflow-y: auto; border-top: 1px solid #333; }
        .flag-btn { height: 40px; background: #333; border: 1px solid #555; border-radius: 4px; color: #fff; font-size: 9px; font-weight: bold; display: flex; align-items: center; justify-content: center; text-align: center; }
        .flag-btn.active { border: 2px solid #fff; transform: scale(0.96); }
        .flag-btn.disabled { opacity: 0.15; pointer-events: none; filter: grayscale(1); }

        /* 配色 */
        .c-hazure { background: #444; }
        .c-rep { background: #0044bb; }
        .c-bell { background: #887700; }
        .c-suika { background: #005500; }
        .c-che { background: #880000; }
        .c-tok { background: #660099; }
        .flag-btn.active.c-rep { background: var(--blue); }
        .flag-btn.active.c-bell { background: var(--yellow); color: #000; }
        .flag-btn.active.c-suika { background: var(--green); }
        .flag-btn.active.c-che { background: var(--red); }
        .flag-btn.active.c-tok { background: var(--purple); }

        footer { padding: 8px; background: #000; }
        .exec-btn { width: 100%; height: 52px; background: linear-gradient(#ff4444, #880000); border: 1px solid #ff6666; border-radius: 8px; color: #fff; font-size: 22px; font-weight: bold; }
    </style>
</head>
<body>

<header class="state-header">
    <div id="st-hazure" class="state-btn st-hazure active" onclick="setState('hazure')">未成立</div>
    <div id="st-don" class="state-btn st-don" onclick="setState('don')">ドン成立</div>
    <div id="st-seven" class="state-btn st-seven" onclick="setState('seven')">７成立</div>
    <div id="st-reg" class="state-btn st-reg" onclick="setState('reg')">Reg成立</div>
</header>

<main>
    <div class="reel-window" id="touch-area">
        <div class="frame-blue"></div>
        <div id="strip-in" class="strip"></div>
    </div>
    <div class="center-info">
        <div class="info-box"><div class="info-label">ストップ位置</div><div id="val-target" class="info-val">1</div></div>
        <div class="info-box" style="border-top:1px solid #333; border-bottom:1px solid #333;"><div class="info-label">滑りコマ数</div><div id="val-slip" class="info-val val-slip">--</div></div>
        <div class="info-box"><div class="info-label">最終停止型</div><div id="val-pos" class="info-val">--</div></div>
    </div>
    <div class="reel-window">
        <div class="frame-red"></div>
        <div id="strip-out" class="strip"></div>
    </div>
</main>

<div class="flag-grid" id="flag-container">
    <div class="flag-btn active c-hazure" id="f-hazure" onclick="setFlag('hazure', 0)">ハズレ</div>
    <div class="flag-btn c-rep" id="f-rep_n" onclick="setFlag('rep_n', 1)">通常リプ</div>
    <div class="flag-btn c-rep" id="f-rep_j" onclick="setFlag('rep_j', 2)">JACリプ</div>
    <div class="flag-btn c-rep" id="f-rep_rt" onclick="setFlag('rep_rt', 3)">RTリプ</div>
    <div class="flag-btn c-bell" id="f-bell_a" onclick="setFlag('bell_a', 4)">ベルA</div>
    <div class="flag-btn c-bell" id="f-bell_b" onclick="setFlag('bell_b', 5)">ベルB</div>
    <div class="flag-btn c-suika" id="f-suika_a" onclick="setFlag('suika_a', 6)">氷A</div>
    <div class="flag-btn c-suika" id="f-suika_b" onclick="setFlag('suika_b', 7)">氷B</div>
    <div class="flag-btn c-che" id="f-che_a1" onclick="setFlag('che_a1', 8)">チェリーA1</div>
    <div class="flag-btn c-che" id="f-che_a2" onclick="setFlag('che_a2', 9)">チェリーA2</div>
    <div class="flag-btn c-che" id="f-che_b" onclick="setFlag('che_b', 10)">チェリーB</div>
    <div class="flag-btn c-tok" id="f-tok_a" onclick="setFlag('tok_a', 11)">特殊役A</div>
    <div class="flag-btn c-tok" id="f-tok_b" onclick="setFlag('tok_b', 12)">特殊役B</div>
    <div class="flag-btn c-tok" id="f-tok_c" onclick="setFlag('tok_c', 13)">特殊役C</div>
    <div class="flag-btn c-tok" id="f-tok_d" onclick="setFlag('tok_d', 14)">特殊役D</div>
    <div class="flag-btn c-tok" id="f-tok_e" onclick="setFlag('tok_e', 15)">特殊役E</div>
</div>

<footer><button class="exec-btn" onclick="execute()">解析実行</button></footer>

<script>
    const DATA_SETS = {
        'hazure': { 21:[1,2,1,1,2,3,2,2,4,4,4,0,0,0,0,0], 20:[0,0,2,0,3,4,0,0,1,1,1,0,0,0,0,0], 19:[0,1,3,1,4,4,0,0,2,2,2,0,0,0,0,0], 18:[1,1,0,1,0,0,2,2,3,3,3,0,0,0,0,0], 17:[0,0,1,0,0,1,1,1,4,4,4,0,0,0,0,0], 16:[2,1,2,1,1,2,3,3,0,0,0,0,0,0,0,0], 15:[3,2,3,2,2,3,3,3,1,1,1,0,0,0,0,0], 14:[3,3,1,3,3,4,4,4,0,0,2,0,0,0,0,0], 13:[0,4,2,4,4,4,0,0,1,1,1,0,0,0,0,0], 12:[1,0,3,0,0,1,1,1,2,2,4,0,0,0,0,0], 11:[0,1,0,0,1,2,1,1,3,3,3,0,0,0,0,0], 10:[1,0,1,1,2,3,2,2,4,4,4,0,0,0,0,0], 9:[2,1,2,1,3,4,2,2,1,1,1,0,0,0,0,0], 8:[0,2,0,2,4,0,3,3,2,2,2,0,0,0,0,0], 7:[1,0,1,0,0,0,4,4,3,3,3,0,0,0,0,0], 6:[2,1,2,1,2,1,1,1,0,0,0,0,0,0,0,0], 5:[3,2,3,2,2,3,2,2,1,1,1,0,0,0,0,0], 4:[4,3,1,3,3,4,3,3,0,0,2,0,0,0,0,0], 3:[0,4,2,4,4,4,0,0,1,1,1,0,0,0,0,0], 2:[1,0,3,0,0,0,0,0,2,2,4,0,0,0,0,0], 1:[1,1,0,0,1,2,1,1,3,3,3,0,0,0,0,0] },
        'don': { 21:[3,2,1,2,2,2,3,3,4,4,4,3,1,1,3,3], 20:[4,0,2,0,3,4,4,4,1,1,1,4,0,2,4,4], 19:[0,1,0,1,4,4,0,0,2,2,2,4,0,0,2,0], 18:[1,1,1,1,0,0,2,2,3,3,3,1,1,1,2,1], 17:[0,0,1,0,0,1,1,1,4,4,4,1,2,2,4,0], 16:[2,1,3,1,1,1,3,3,0,0,0,1,3,2,3,2], 15:[2,2,3,2,2,3,3,3,1,1,1,4,3,4,3,2], 14:[3,3,4,3,3,4,4,4,0,0,2,4,4,4,3,3], 13:[0,4,0,4,0,4,0,0,1,1,1,0,0,0,0,0], 12:[1,0,0,0,0,1,1,1,2,2,4,1,1,1,1,1], 11:[0,1,1,1,1,1,0,0,3,3,3,0,0,0,0,0], 10:[1,0,2,0,3,2,1,1,4,4,4,1,1,1,0,1], 9:[1,1,4,1,4,4,2,2,1,1,1,2,2,1,2,1], 8:[1,2,0,2,0,0,3,3,2,2,2,3,2,1,1,1], 7:[1,0,1,0,0,0,4,4,3,3,1,4,2,3,4,3], 6:[1,1,2,1,1,1,1,1,0,0,0,2,4,3,3,3], 5:[3,2,2,2,3,2,2,2,1,1,1,2,4,4,4,4], 4:[3,3,4,3,3,3,3,3,0,0,0,4,4,3,4,3], 3:[0,4,0,4,0,4,0,0,1,1,1,0,0,0,0,0], 2:[1,0,1,0,0,0,1,1,2,2,2,1,1,1,1,1], 1:[2,1,0,1,1,1,2,2,3,3,3,2,0,0,2,2] },
        'seven': { 21:[1,2,0,2,2,3,2,2,4,4,4,2,1,1,1,1], 20:[0,1,1,0,3,4,0,0,0,1,1,3,0,0,0,0], 19:[0,0,1,1,4,4,0,0,1,2,2,0,0,1,0,0], 18:[1,2,1,1,0,0,0,0,2,3,3,0,1,2,1,1], 17:[1,0,0,0,0,1,1,1,3,4,4,0,2,1,0,0], 16:[1,1,1,1,1,1,3,3,0,0,0,3,3,2,3,3], 15:[4,2,0,2,2,2,3,3,1,1,1,2,3,3,3,3], 14:[4,3,3,3,3,4,4,4,2,0,2,3,4,4,3,3], 13:[4,4,4,4,4,0,0,0,1,1,1,0,4,0,4,0], 12:[1,0,1,0,0,1,1,1,4,2,4,0,1,1,1,1], 11:[2,1,4,1,1,2,1,1,3,3,3,1,0,2,0,2], 10:[3,2,1,0,2,3,2,2,4,4,4,1,1,1,1,1], 9:[4,1,1,1,3,4,2,2,2,1,1,2,2,2,2,2], 8:[0,4,3,2,4,0,3,3,3,2,2,3,2,3,2,2], 7:[0,0,0,0,0,0,4,4,4,3,3,4,2,3,2,2], 6:[2,4,1,1,2,2,1,1,0,0,0,1,4,3,4,4], 5:[2,2,0,2,2,2,2,2,1,1,1,3,4,4,4,4], 4:[4,3,1,3,3,4,3,3,2,0,2,3,4,3,4,4], 3:[0,4,4,4,4,0,0,0,1,1,1,0,0,0,0,0], 2:[1,0,3,0,0,1,0,0,4,2,4,0,1,1,1,1], 1:[0,1,4,1,1,2,1,1,3,3,3,1,0,0,0,0] },
        'reg': { 21:[1,2,2,2,2,3,2,2,4,4,4,1,1,1,1,1], 20:[0,1,0,0,3,4,0,0,1,1,1,0,0,0,2,0], 19:[0,0,1,1,4,4,0,0,2,2,2,0,1,1,0,0], 18:[1,2,1,1,0,0,0,0,3,3,3,0,2,2,1,1], 17:[0,0,0,0,0,1,1,1,4,4,4,1,1,1,0,0], 16:[3,1,1,1,1,1,3,3,0,0,0,2,2,2,2,3], 15:[3,2,2,2,2,2,3,3,1,1,1,3,3,3,2,3], 14:[3,3,3,3,3,4,4,4,0,0,0,4,4,4,3,3], 13:[0,4,4,4,4,0,0,0,1,1,1,0,0,0,0,0], 12:[1,0,0,0,0,1,1,1,2,2,2,1,1,1,1,1], 11:[2,1,1,1,1,2,2,2,3,3,3,2,0,2,0,0], 10:[3,2,0,0,2,3,3,3,4,4,4,3,1,1,1,1], 9:[4,1,1,1,3,4,4,4,4,4,4,4,2,2,1,2], 8:[2,4,2,2,4,0,3,3,2,2,2,3,3,3,1,3], 7:[2,0,0,0,0,0,4,4,3,3,1,4,3,3,3,4], 6:[2,4,1,1,2,2,1,1,0,0,0,3,3,3,3,4], 5:[2,2,2,2,2,2,2,2,1,1,1,4,4,4,4,4], 4:[4,3,3,3,3,4,3,3,0,0,2,3,3,3,3,4], 3:[0,4,4,4,4,0,0,0,1,1,1,0,0,0,0,0], 2:[1,0,0,0,0,1,0,0,2,2,4,1,1,1,1,1], 1:[0,1,1,1,1,2,1,1,3,3,3,0,0,0,0,0] }
    };

    let selectedState = 'hazure';
    let selectedFlagIdx = 0;
    let selectedIdx = 1;
    let SH = 0; // Symbol Height (計算値)

    function setState(id) {
        document.querySelectorAll('.state-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('st-' + id).classList.add('active');
        selectedState = id;
        updateFlagUI();
    }

    function updateFlagUI() {
        const isHazure = (selectedState === 'hazure');
        const tokKeys = ['tok_a','tok_b','tok_c','tok_d','tok_e'];
        tokKeys.forEach(k => {
            const btn = document.getElementById('f-' + k);
            btn.classList.toggle('disabled', isHazure);
            if(isHazure && btn.classList.contains('active')) setFlag('hazure', 0);
        });
    }

    function setFlag(id, idx) {
        document.querySelectorAll('.flag-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('f-' + id).classList.add('active');
        selectedFlagIdx = idx;
    }

    function execute() {
        // hanabi.html準拠：狙い位置から制御テーブル分「進む（足す）」
        const slip = DATA_SETS[selectedState][selectedIdx][selectedFlagIdx];
        let stopIdx = selectedIdx + slip;
        while (stopIdx > 21) stopIdx -= 21;

        document.getElementById('val-slip').innerText = slip;
        document.getElementById('val-pos').innerText = stopIdx;
        
        // 右リール：最終停止位置（インデックスstopIdx）を中段に
        // 中段にくるべきインデックスがstopIdx。windowの上端からは(stopIdx - 4)個分
        document.getElementById('strip-out').style.transform = `translateY(${-(21 + stopIdx - 4) * SH}px)`;
    }

    function createStrips() {
        SH = document.getElementById('touch-area').offsetHeight / 7;
        ['strip-in', 'strip-out'].forEach(id => {
            const el = document.getElementById(id);
            for(let i=0; i<63; i++) {
                const symIdx = (i % 21) + 1;
                const d = document.createElement('div');
                d.className = 'symbol';
                d.style.height = SH + 'px';
                // 背景位置：1(Don)が一番上(0%), 21(7)が一番下。正順。
                d.style.backgroundPosition = `0 ${(symIdx - 1) * 5}%`;
                el.appendChild(d);
            }
        });
        updateInReel();
    }

    function updateInReel() {
        // 中段（4コマ目）にselectedIdxを表示
        document.getElementById('strip-in').style.transform = `translateY(${-(21 + selectedIdx - 4) * SH}px)`;
        document.getElementById('val-target').innerText = selectedIdx;
    }

    const touchArea = document.getElementById('touch-area');
    let startY = 0, baseIdx = 0;
    touchArea.addEventListener('touchstart', e => {
        startY = e.touches[0].pageY;
        baseIdx = selectedIdx;
        document.getElementById('strip-in').style.transition = 'none';
    });
    touchArea.addEventListener('touchmove', e => {
        let diff = e.touches[0].pageY - startY;
        let moveCount = Math.round(diff / SH);
        // パチスロの挙動：下に引くとリールは上に（インデックスは減少）
        let newIdx = baseIdx - moveCount;
        while(newIdx < 1) newIdx += 21;
        while(newIdx > 21) newIdx -= 21;
        if(newIdx !== selectedIdx) {
            selectedIdx = newIdx;
            updateInReel();
        }
    });
    touchArea.addEventListener('touchend', () => {
        document.getElementById('strip-in').style.transition = 'transform 0.1s ease-out';
        updateInReel(); // 完全吸着
    });

    window.onload = () => { createStrips(); updateFlagUI(); };
</script>
</body>
</html>