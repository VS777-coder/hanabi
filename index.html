<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hanabi Analyzer</title>
    <style>
        :root {
            --reel-w: 110px; 
            --blue: #00bbff; --red: #ff3333; --yellow: #ffff00;
            --cyan: #00ccff; --green: #00aa00;
        }
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            margin: 0; padding: 0; 
            user-select: none; 
            -webkit-user-select: none;
            touch-action: manipulation;
        }
        body { 
            background: #000; color: #fff; font-family: sans-serif; 
            height: 100dvh; overflow: hidden; display: flex; flex-direction: column; 
            overscroll-behavior-y: none;
        }

        .state-header { display: flex; gap: 4px; padding: 6px; background: #111; flex-shrink: 0; }
        .state-btn { flex: 1; height: 44px; border-radius: 4px; font-size: 10px; font-weight: bold; display: flex; align-items: center; justify-content: center; border: 2px solid #444; text-align: center; color: #fff; }
        #st-hazure { background: #333; }
        #st-don { background: #0040ff; }
        #st-seven { background: #ff0000; }
        #st-reg { background: #222; border-color: #666; }
        .state-btn.active { border-color: #0f0; box-shadow: 0 0 10px #0f0; }

        main { flex: 1; display: flex; align-items: center; justify-content: center; gap: 4px; min-height: 0; touch-action: none; }
        .reel-window { 
            width: var(--reel-w); 
            height: 350px; 
            background: #fff; 
            overflow: hidden; 
            position: relative; 
            border: 2px solid #333; 
        }
        .strip { width: 100%; position: absolute; left: 0; top: 0; pointer-events: none; }
        .symbol { 
            width: 100%; 
            height: 50px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            position: relative;
        }
        .symbol-image { 
            position: absolute; 
            width: 100%; 
            height: 100%; 
            background-image: url('hanabi.png'); 
            background-size: 100% 2100%; 
            background-repeat: repeat-y;
        }

        .frame-blue { position: absolute; top: 100px; width: 100%; height: 150px; border: 6px solid var(--blue); z-index: 10; pointer-events: none; }
        .frame-red { position: absolute; top: 100px; width: 100%; height: 150px; border: 6px solid var(--red); z-index: 10; pointer-events: none; }

        .center-panel { display: flex; flex-direction: column; justify-content: space-between; width: 90px; height: 350px; padding: 10px 0; }
        .info-box { background: #1a1a1a; border: 1px solid #333; border-radius: 4px; padding: 4px; text-align: center; }
        .info-label { font-size: 9px; color: #aaa; }
        .info-val { font-size: 16px; font-weight: bold; }
        .val-slip { color: var(--yellow); font-size: 32px; }

        .flag-grid { padding: 4px; background: #111; display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; flex-shrink: 0; }
        .flag-btn { height: 38px; border-radius: 4px; color: #fff; font-size: 9px; font-weight: bold; display: flex; align-items: center; justify-content: center; text-align: center; border: 1px solid #444; }
        .f-hazure { background: #444; }
        .f-rep    { background: var(--cyan); color: #000; } /* リプ：水色 */
        .f-bell   { background: var(--yellow); color: #000; }
        .f-suika  { background: var(--green); } /* 氷：緑 */
        .f-che    { background: var(--red); } /* チェリー：赤 */
        .f-tok    { background: #660099; }
        .flag-btn.active { border: 2px solid #fff; box-shadow: 0 0 5px #fff; }
        .flag-btn.disabled { opacity: 0.2; pointer-events: none; }

        footer { padding: 8px; background: #000; }
        .exec-btn { width: 100%; height: 54px; background: linear-gradient(#ff4444, #880000); border-radius: 8px; color: #fff; font-size: 20px; font-weight: bold; border: 2px solid #ff9999; }
    </style>
</head>
<body>

<header class="state-header">
    <div id="st-hazure" class="state-btn active" onclick="setState('hazure')">ボーナス<br>未成立</div>
    <div id="st-don" class="state-btn" onclick="setState('don')">ドンビッグ<br>成立</div>
    <div id="st-seven" class="state-btn" onclick="setState('seven')">７ビッグ<br>成立</div>
    <div id="st-reg" class="state-btn" onclick="setState('reg')">Regボーナス<br>成立</div>
</header>

<main>
    <div class="reel-window" id="touch-area">
        <div class="frame-blue"></div>
        <div id="strip-in" class="strip"></div>
    </div>
    <div class="center-panel">
        <div class="info-box"><div class="info-label">ストップ位置</div><div id="val-input" class="info-val">--</div></div>
        <div class="info-box"><div class="info-label">滑りコマ数</div><div id="val-slip" class="info-val val-slip">--</div></div>
        <div class="info-box"><div class="info-label">停止位置</div><div id="val-result" class="info-val">--</div></div>
    </div>
    <div class="reel-window">
        <div class="frame-red"></div>
        <div id="strip-out" class="strip"></div>
    </div>
</main>

<div class="flag-grid" id="flag-container">
    <div class="flag-btn f-hazure active" onclick="setFlag(0, this)">ハズレ</div>
    <div class="flag-btn f-rep" onclick="setFlag(1, this)">通常リプ</div>
    <div class="flag-btn f-rep" onclick="setFlag(2, this)">JACリプ</div>
    <div class="flag-btn f-rep" onclick="setFlag(3, this)">RTリプ</div>
    <div class="flag-btn f-bell" onclick="setFlag(4, this)">ベルA</div>
    <div class="flag-btn f-bell" onclick="setFlag(5, this)">ベルB</div>
    <div class="flag-btn f-suika" onclick="setFlag(6, this)">氷A</div>
    <div class="flag-btn f-suika" onclick="setFlag(7, this)">氷B</div>
    <div class="flag-btn f-che" onclick="setFlag(8, this)">チェリーA1</div>
    <div class="flag-btn f-che" onclick="setFlag(9, this)">チェリーA2</div>
    <div class="flag-btn f-che" onclick="setFlag(10, this)">チェリーB</div>
    <div class="flag-btn f-tok" onclick="setFlag(11, this)">特役A</div>
    <div class="flag-btn f-tok" onclick="setFlag(12, this)">特役B</div>
    <div class="flag-btn f-tok" onclick="setFlag(13, this)">特役C</div>
    <div class="flag-btn f-tok" onclick="setFlag(14, this)">特役D</div>
    <div class="flag-btn f-tok" onclick="setFlag(15, this)">特役E</div>
</div>

<footer><button class="exec-btn" onclick="executeControl()">解析実行</button></footer>

<script>
    const REEL_COUNT = 21;
    const SH = 50; 
    let currentState = 'hazure';
    let selectedFlagIdx = 0;
    let selectedTopIdx = 1;

    const DATA_SETS = {
        'hazure': {21:[1,2,1,1,2,3,2,2,4,4,4,0,0,0,0,0],20:[0,0,2,0,3,4,0,0,1,1,1,0,0,0,0,0],19:[0,1,3,1,4,4,0,0,2,2,2,0,0,0,0,0],18:[1,1,0,1,0,0,2,2,3,3,3,0,0,0,0,0],17:[0,0,1,0,0,1,1,1,4,4,4,0,0,0,0,0],16:[2,1,2,1,1,2,3,3,0,0,0,0,0,0,0,0],15:[3,2,3,2,2,3,3,3,1,1,1,0,0,0,0,0],14:[3,3,1,3,3,4,4,4,0,0,2,0,0,0,0,0],13:[0,4,2,4,4,4,0,0,1,1,1,0,0,0,0,0],12:[1,0,3,0,0,1,1,1,2,2,4,0,0,0,0,0],11:[0,1,0,0,1,2,1,1,3,3,3,0,0,0,0,0],10:[1,0,1,1,2,3,2,2,4,4,4,0,0,0,0,0],9:[2,1,2,1,3,4,2,2,1,1,1,0,0,0,0,0],8:[0,2,0,2,4,0,3,3,2,2,2,0,0,0,0,0],7:[1,0,1,0,0,0,4,4,3,3,3,0,0,0,0,0],6:[2,1,2,1,2,1,1,1,0,0,0,0,0,0,0,0],5:[3,2,3,2,2,3,2,2,1,1,1,0,0,0,0,0],4:[4,3,1,3,3,4,3,3,0,0,2,0,0,0,0,0],3:[0,4,2,4,4,4,0,0,1,1,1,0,0,0,0,0],2:[1,0,3,0,0,0,0,0,2,2,4,0,0,0,0,0],1:[1,1,0,0,1,2,1,1,3,3,3,0,0,0,0,0]},
        'don': {21:[3,2,1,2,2,2,3,3,4,4,4,3,1,1,3,3],20:[4,0,2,0,3,4,4,4,1,1,1,4,0,2,4,4],19:[0,1,0,1,4,4,0,0,2,2,2,4,0,0,2,0],18:[1,1,1,1,0,0,2,2,3,3,3,1,1,1,2,1],17:[0,0,1,0,0,1,1,1,4,4,4,1,2,2,4,0],16:[2,1,3,1,1,1,3,3,0,0,0,1,3,2,3,2],15:[2,2,3,2,2,3,3,3,1,1,1,4,3,4,3,2],14:[3,3,4,3,3,4,4,4,0,0,2,4,4,4,3,3],13:[0,4,0,4,0,4,0,0,1,1,1,0,0,0,0,0],12:[1,0,0,0,0,1,1,1,2,2,4,1,1,1,1,1],11:[0,1,1,1,1,1,0,0,3,3,3,0,0,0,0,0],10:[1,0,2,0,3,2,1,1,4,4,4,1,1,1,0,1],9:[1,1,4,1,4,4,2,2,1,1,1,2,2,1,2,1],8:[1,2,0,2,0,0,3,3,2,2,2,3,2,1,1,1],7:[1,0,1,0,0,0,4,4,3,3,1,4,2,3,4,3],6:[1,1,2,1,1,1,1,1,0,0,0,2,4,3,3,3],5:[3,2,2,2,3,2,2,2,1,1,1,2,4,4,4,4],4:[3,3,4,3,3,3,3,3,0,0,0,4,4,3,4,3],3:[0,4,0,4,0,4,0,0,1,1,1,0,0,0,0,0],2:[1,0,1,0,0,0,1,1,2,2,2,1,1,1,1,1],1:[2,1,0,1,1,1,2,2,3,3,3,2,0,0,2,2]},
        'seven': {21:[1,2,0,2,2,3,2,2,4,4,4,2,1,1,1,1],20:[0,1,1,0,3,4,0,0,0,1,1,3,0,0,0,0],19:[0,0,1,1,4,4,0,0,1,2,2,0,0,1,0,0],18:[1,2,1,1,0,0,0,0,2,3,3,0,1,2,1,1],17:[1,0,0,0,0,1,1,1,3,4,4,0,2,1,0,0],16:[1,1,1,1,1,1,3,3,0,0,0,3,3,2,3,3],15:[4,2,0,2,2,2,3,3,1,1,1,2,3,3,3,3],14:[4,3,3,3,3,4,4,4,2,0,2,3,4,4,3,3],13:[4,4,4,4,4,0,0,0,1,1,1,0,4,0,4,0],12:[1,0,1,0,0,1,1,1,4,2,4,0,1,1,1,1],11:[2,1,4,1,1,2,1,1,3,3,3,1,0,2,0,2],10:[3,2,1,0,2,3,2,2,4,4,4,1,1,1,1,1],9:[4,1,1,1,3,4,2,2,2,1,1,2,2,2,2,2],8:[0,4,3,2,4,0,3,3,3,2,2,3,2,3,2,2],7:[0,0,0,0,0,0,4,4,4,3,3,4,2,3,2,2],6:[2,4,1,1,2,2,1,1,0,0,0,1,4,3,4,4],5:[2,2,0,2,2,2,2,2,1,1,1,3,4,4,4,4],4:[4,3,1,3,3,4,3,3,2,0,2,3,4,3,4,4],3:[0,4,4,4,4,0,0,0,1,1,1,0,0,0,0,0],2:[1,0,3,0,0,1,0,0,4,2,4,0,1,1,1,1],1:[0,1,4,1,1,2,1,1,3,3,3,1,0,0,0,0]},
        'reg': {21:[1,2,2,2,2,3,2,2,4,4,4,1,1,1,1,1],20:[0,1,0,0,3,4,0,0,1,1,1,0,0,0,2,0],19:[0,0,1,1,4,4,0,0,2,2,2,0,1,1,0,0],18:[1,2,1,1,0,0,0,0,3,3,3,0,2,2,1,1],17:[0,0,0,0,0,1,1,1,4,4,4,1,1,1,0,0],16:[3,1,1,1,1,1,3,3,0,0,0,2,2,2,2,3],15:[3,2,2,2,2,2,3,3,1,1,1,3,3,3,2,3],14:[3,3,3,3,3,4,4,4,0,0,0,4,4,4,3,3],13:[0,4,4,4,4,0,0,0,1,1,1,0,0,0,0,0],12:[1,0,0,0,0,1,1,1,2,2,2,1,1,1,1,1],11:[2,1,1,1,1,2,2,2,3,3,3,2,0,2,0,0],10:[3,2,0,0,2,3,3,3,4,4,4,3,1,1,1,1],9:[4,1,1,1,3,4,4,4,4,4,4,4,2,2,1,2],8:[2,4,2,2,4,0,3,3,2,2,2,3,3,3,1,3],7:[2,0,0,0,0,0,4,4,3,3,1,4,3,3,3,4],6:[2,4,1,1,2,2,1,1,0,0,0,3,3,3,3,4],5:[2,2,2,2,2,2,2,2,1,1,1,4,4,4,4,4],4:[4,3,3,3,3,4,3,3,0,0,2,3,3,3,3,4],3:[0,4,4,4,4,0,0,0,1,1,1,0,0,0,0,0],2:[1,0,0,0,0,1,0,0,2,2,4,1,1,1,1,1],1:[0,1,1,1,1,2,1,1,3,3,3,0,0,0,0,0]}
    };

    function init() {
        ['strip-in', 'strip-out'].forEach(id => {
            const el = document.getElementById(id);
            el.innerHTML = '';
            for(let i=0; i<63; i++) {
                const idx = (i % REEL_COUNT) + 1;
                const d = document.createElement('div');
                d.className = 'symbol';
                d.innerHTML = `<div class="symbol-image" style="background-position:0 ${(idx-1)*5}%"></div>`;
                el.appendChild(d);
            }
        });
        updateInReel(false);
        refreshFlagButtons();
    }

    function updateInReel(animate = true) {
        const strip = document.getElementById('strip-in');
        strip.style.transition = animate ? 'transform 0.1s ease-out' : 'none';
        strip.style.transform = `translateY(${-(REEL_COUNT + selectedTopIdx - 1) * SH}px)`;
        let midIdx = selectedTopIdx + 1; 
        if(midIdx > REEL_COUNT) midIdx -= REEL_COUNT;
        document.getElementById('val-input').innerText = midIdx;
    }

    function setState(id) {
        document.querySelectorAll('.state-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('st-' + id).classList.add('active');
        currentState = id;
        if (currentState === 'hazure' && selectedFlagIdx >= 11) {
            const hazureBtn = document.querySelector('.f-hazure');
            setFlag(0, hazureBtn);
        }
        refreshFlagButtons();
    }

    function refreshFlagButtons() {
        const buttons = document.querySelectorAll('.f-tok');
        buttons.forEach(btn => {
            if (currentState === 'hazure') btn.classList.add('disabled');
            else btn.classList.remove('disabled');
        });
    }

    function setFlag(idx, btn) {
        document.querySelectorAll('.flag-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedFlagIdx = idx;
    }

    function executeControl() {
        let midIdx = selectedTopIdx + 1;
        if(midIdx > REEL_COUNT) midIdx -= REEL_COUNT;
        const slip = DATA_SETS[currentState][midIdx][selectedFlagIdx];
        
        // 滑り方向をプラス（リール送り方向）に修正
        let stopMidIdx = midIdx + slip;
        while(stopMidIdx > REEL_COUNT) stopMidIdx -= REEL_COUNT;

        document.getElementById('val-slip').innerText = slip;
        document.getElementById('val-result').innerText = stopMidIdx;

        const stripOut = document.getElementById('strip-out');
        const outTopIdx = stopMidIdx - 1;
        stripOut.style.transition = 'transform 0.4s cubic-bezier(0.1, 0.7, 0.1, 1)';
        stripOut.style.transform = `translateY(${-(REEL_COUNT + outTopIdx - 1) * SH}px)`;
    }

    const touchArea = document.getElementById('touch-area');
    let startY = 0, startIdx = 0;
    touchArea.addEventListener('touchstart', e => { 
        startY = e.touches[0].pageY; 
        startIdx = selectedTopIdx; 
    }, {passive:false});
    
    touchArea.addEventListener('touchmove', e => {
        e.preventDefault();
        let moveCount = Math.round((e.touches[0].pageY - startY) / SH);
        let newIdx = startIdx - moveCount;
        while(newIdx < 1) newIdx += REEL_COUNT;
        while(newIdx > REEL_COUNT) newIdx -= REEL_COUNT;
        if(newIdx !== selectedTopIdx) { 
            selectedTopIdx = newIdx; 
            updateInReel(false); 
        }
    }, {passive:false});

    window.onload = init;
</script>
</body>
</html>