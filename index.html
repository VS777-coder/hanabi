<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hanabi Mobile - Fixed Logic</title>
    <style>
        :root {
            --reel-w: 125px; 
            --sym-h: calc(100vh / 20); 
            --red: #ff3333; --blue: #3399ff; --green: #22cc22; --yellow: #ffff00; --purple: #cc33ff;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        body { background: #000; color: #fff; font-family: sans-serif; height: 100svh; overflow: hidden; display: flex; flex-direction: column; }

        .state-header { display: flex; gap: 4px; padding: 6px; background: #111; }
        .state-btn { flex: 1; height: 40px; border-radius: 4px; font-size: 11px; font-weight: bold; display: flex; align-items: center; justify-content: center; border: 2px solid #444; }
        .state-btn.active { border-color: #0f0; box-shadow: 0 0 8px #0f0; }
        .st-hazure { background: #333; color: #fff; }
        .st-don { background: #0040ff; color: #fff; }
        .st-seven { background: #ff0000; color: #fff; }
        .st-reg { background: #222; color: #fff; border: 1px solid #666; }

        main { flex: 1; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .reel-window { width: var(--reel-w); height: calc(var(--sym-h) * 7); background: #fff; overflow: hidden; position: relative; border: 2px solid #333; }
        .strip { width: 100%; position: absolute; transition: transform 0.1s ease-out; }
        .symbol { width: 100%; height: var(--sym-h); background-image: url('hanabi.png'); background-size: 100% 2100%; border-bottom: 1px solid rgba(0,0,0,0.1); }

        .center-info { display: flex; flex-direction: column; justify-content: space-around; height: calc(var(--sym-h) * 5); width: 85px; background: #111; border: 1px solid #333; }
        .info-box { text-align: center; }
        .info-label { font-size: 9px; color: #aaa; }
        .info-val { font-size: 20px; font-weight: bold; color: #fff; }
        .val-slip { color: var(--yellow); font-size: 28px; }

        /* 枠線強化 */
        .frame-blue { position: absolute; top: calc(var(--sym-h) * 2); width: 100%; height: calc(var(--sym-h) * 3); border: 6px solid var(--blue); z-index: 10; pointer-events: none; }
        .frame-red { position: absolute; top: calc(var(--sym-h) * 2); width: 100%; height: calc(var(--sym-h) * 3); border: 6px solid var(--red); z-index: 10; pointer-events: none; }

        .flag-grid { padding: 4px; background: #1a1a1a; display: grid; grid-template-columns: repeat(4, 1fr); gap: 3px; max-height: 40%; overflow-y: auto; border-top: 1px solid #333; }
        .flag-btn { height: 38px; background: #333; border: 1px solid #555; border-radius: 4px; color: #fff; font-size: 9px; font-weight: bold; display: flex; align-items: center; justify-content: center; }
        .flag-btn.active { border: 2px solid #fff; }
        .flag-btn.disabled { opacity: 0.1; pointer-events: none; }

        /* カラー設定 */
        .c-hazure { background: #444; }
        .c-rep { background: #0044bb; }
        .c-bell { background: #887700; }
        .c-suika { background: #005500; }
        .c-che { background: #880000; }
        .c-tok { background: #550088; }
        .flag-btn.active.c-rep { background: var(--blue); }
        .flag-btn.active.c-bell { background: var(--yellow); color:#000; }
        .flag-btn.active.c-suika { background: var(--green); }
        .flag-btn.active.c-che { background: var(--red); }
        .flag-btn.active.c-tok { background: var(--purple); }

        footer { padding: 6px; }
        .exec-btn { width: 100%; height: 50px; background: linear-gradient(#ff4444, #880000); border: 1px solid #ff6666; border-radius: 8px; color: #fff; font-size: 20px; font-weight: bold; }
    </style>
</head>
<body>

<header class="state-header">
    <div id="st-hazure" class="state-btn st-hazure active" onclick="setState('hazure')">未成立</div>
    <div id="st-don" class="state-btn st-don" onclick="setState('don')">ドン成立</div>
    <div id="st-seven" class="state-btn st-seven" onclick="setState('seven')">７成立</div>
    <div id="st-reg" class="state-btn st-reg" onclick="setState('reg')">Reg成立</div>
</header>

<main>
    <div class="reel-window" id="touch-area">
        <div class="frame-blue"></div>
        <div id="strip-in" class="strip"></div>
    </div>
    <div class="center-info">
        <div class="info-box"><div class="info-label">ストップ位置</div><div id="val-target" class="info-val">1</div></div>
        <div class="info-box" style="border-y:1px solid #333;"><div class="info-label">滑りコマ数</div><div id="val-slip" class="info-val val-slip">--</div></div>
        <div class="info-box"><div class="info-label">最終停止型</div><div id="val-pos" class="info-val">--</div></div>
    </div>
    <div class="reel-window">
        <div class="frame-red"></div>
        <div id="strip-out" class="strip"></div>
    </div>
</main>

<div class="flag-grid" id="flag-container">
    <div class="flag-btn active c-hazure" id="f-hazure" onclick="setFlag('hazure', 0)">ハズレ</div>
    <div class="flag-btn c-rep" id="f-rep_n" onclick="setFlag('rep_n', 1)">通常リプ</div>
    <div class="flag-btn c-rep" id="f-rep_j" onclick="setFlag('rep_j', 2)">JACリプ</div>
    <div class="flag-btn c-rep" id="f-rep_rt" onclick="setFlag('rep_rt', 3)">RTリプ</div>
    <div class="flag-btn c-bell" id="f-bell_a" onclick="setFlag('bell_a', 4)">ベルA</div>
    <div class="flag-btn c-bell" id="f-bell_b" onclick="setFlag('bell_b', 5)">ベルB</div>
    <div class="flag-btn c-suika" id="f-suika_a" onclick="setFlag('suika_a', 6)">氷A</div>
    <div class="flag-btn c-suika" id="f-suika_b" onclick="setFlag('suika_b', 7)">氷B</div>
    <div class="flag-btn c-che" id="f-che_a1" onclick="setFlag('che_a1', 8)">チェリーA1</div>
    <div class="flag-btn c-che" id="f-che_a2" onclick="setFlag('che_a2', 9)">チェリーA2</div>
    <div class="flag-btn c-che" id="f-che_b" onclick="setFlag('che_b', 10)">チェリーB</div>
    <div class="flag-btn c-tok" id="f-tok_a" onclick="setFlag('tok_a', 11)">特殊役A</div>
    <div class="flag-btn c-tok" id="f-tok_b" onclick="setFlag('tok_b', 12)">特殊役B</div>
    <div class="flag-btn c-tok" id="f-tok_c" onclick="setFlag('tok_c', 13)">特殊役C</div>
    <div class="flag-btn c-tok" id="f-tok_d" onclick="setFlag('tok_d', 14)">特殊役D</div>
    <div class="flag-btn c-tok" id="f-tok_e" onclick="setFlag('tok_e', 15)">特殊役E</div>
</div>

<footer><button class="exec-btn" onclick="execute()">解析実行</button></footer>

<script>
    // 1(Don)から21(Seven)の正順。21->1のループを考慮。
    const DATA_SETS = {
        'hazure': { 21:[1,2,1,1,2,3,2,2,4,4,4,0,0,0,0,0], 20:[0,0,2,0,3,4,0,0,1,1,1,0,0,0,0,0], 19:[0,1,3,1,4,4,0,0,2,2,2,0,0,0,0,0], 18:[1,1,0,1,0,0,2,2,3,3,3,0,0,0,0,0], 17:[0,0,1,0,0,1,1,1,4,4,4,0,0,0,0,0], 16:[2,1,2,1,1,2,3,3,0,0,0,0,0,0,0,0], 15:[3,2,3,2,2,3,3,3,1,1,1,0,0,0,0,0], 14:[3,3,1,3,3,4,4,4,0,0,2,0,0,0,0,0], 13:[0,4,2,4,4,4,0,0,1,1,1,0,0,0,0,0], 12:[1,0,3,0,0,1,1,1,2,2,4,0,0,0,0,0], 11:[0,1,0,0,1,2,1,1,3,3,3,0,0,0,0,0], 10:[1,0,1,1,2,3,2,2,4,4,4,0,0,0,0,0], 9:[2,1,2,1,3,4,2,2,1,1,1,0,0,0,0,0], 8:[0,2,0,2,4,0,3,3,2,2,2,0,0,0,0,0], 7:[1,0,1,0,0,0,4,4,3,3,3,0,0,0,0,0], 6:[2,1,2,1,2,1,1,1,0,0,0,0,0,0,0,0], 5:[3,2,3,2,2,3,2,2,1,1,1,0,0,0,0,0], 4:[4,3,1,3,3,4,3,3,0,0,2,0,0,0,0,0], 3:[0,4,2,4,4,4,0,0,1,1,1,0,0,0,0,0], 2:[1,0,3,0,0,0,0,0,2,2,4,0,0,0,0,0], 1:[1,1,0,0,1,2,1,1,3,3,3,0,0,0,0,0] },
        'don': { 21:[3,2,1,2,2,2,3,3,4,4,4,3,1,1,3,3], 20:[4,0,2,0,3,4,4,4,1,1,1,4,0,2,4,4], 19:[0,1,0,1,4,4,0,0,2,2,2,4,0,0,2,0], 18:[1,1,1,1,0,0,2,2,3,3,3,1,1,1,2,1], 17:[0,0,1,0,0,1,1,1,4,4,4,1,2,2,4,0], 16:[2,1,3,1,1,1,3,3,0,0,0,1,3,2,3,2], 15:[2,2,3,2,2,3,3,3,1,1,1,4,3,4,3,2], 14:[3,3,4,3,3,4,4,4,0,0,2,4,4,4,3,3], 13:[0,4,0,4,0,4,0,0,1,1,1,0,0,0,0,0], 12:[1,0,0,0,0,1,1,1,2,2,4,1,1,1,1,1], 11:[0,1,1,1,1,1,0,0,3,3,3,0,0,0,0,0], 10:[1,0,2,0,3,2,1,1,4,4,4,1,1,1,0,1], 9:[1,1,4,1,4,4,2,2,1,1,1,2,2,1,2,1], 8:[1,2,0,2,0,0,3,3,2,2,2,3,2,1,1,1], 7:[1,0,1,0,0,0,4,4,3,3,1,4,2,3,4,3], 6:[1,1,2,1,1,1,1,1,0,0,0,2,4,3,3,3], 5:[3,2,2,2,3,2,2,2,1,1,1,2,4,4,4,4], 4:[3,3,4,3,3,3,3,3,0,0,0,4,4,3,4,3], 3:[0,4,0,4,0,4,0,0,1,1,1,0,0,0,0,0], 2:[1,0,1,0,0,0,1,1,2,2,2,1,1,1,1,1], 1:[2,1,0,1,1,1,2,2,3,3,3,2,0,0,2,2] },
        'seven': { 21:[1,2,0,2,2,3,2,2,4,4,4,2,1,1,1,1], 20:[0,1,1,0,3,4,0,0,0,1,1,3,0,0,0,0], 19:[0,0,1,1,4,4,0,0,1,2,2,0,0,1,0,0], 18:[1,2,1,1,0,0,0,0,2,3,3,0,1,2,1,1], 17:[1,0,0,0,0,1,1,1,3,4,4,0,2,1,0,0], 16:[1,1,1,1,1,1,3,3,0,0,0,3,3,2,3,3], 15:[4,2,0,2,2,2,3,3,1,1,1,2,3,3,3,3], 14:[4,3,3,3,3,4,4,4,2,0,2,3,4,4,3,3], 13:[4,4,4,4,4,0,0,0,1,1,1,0,4,0,4,0], 12:[1,0,1,0,0,1,1,1,4,2,4,0,1,1,1,1], 11:[2,1,4,1,1,2,1,1,3,3,3,1,0,2,0,2], 10:[3,2,1,0,2,3,2,2,4,4,4,1,1,1,1,1], 9:[4,1,1,1,3,4,2,2,2,1,1,2,2,2,2,2], 8:[0,4,3,2,4,0,3,3,3,2,2,3,2,3,2,2], 7:[0,0,0,0,0,0,4,4,4,3,3,4,2,3,2,2], 6:[2,4,1,1,2,2,1,1,0,0,0,1,4,3,4,4], 5:[2,2,0,2,2,2,2,2,1,1,1,3,4,4,4,4], 4:[4,3,1,3,3,4,3,3,2,0,2,3,4,3,4,4], 3:[0,4,4,4,4,0,0,0,1,1,1,0,0,0,0,0], 2:[1,0,3,0,0,1,0,0,4,2,4,0,1,1,1,1], 1:[0,1,4,1,1,2,1,1,3,3,3,1,0,0,0,0] },
        'reg': { 21:[1,2,2,2,2,3,2,2,4,4,4,1,1,1,1,1], 20:[0,1,0,0,3,4,0,0,1,1,1,0,0,0,2,0], 19:[0,0,1,1,4,4,0,0,2,2,2,0,1,1,0,0], 18:[1,2,1,1,0,0,0,0,3,3,3,0,2,2,1,1], 17:[0,0,0,0,0,1,1,1,4,4,4,1,1,1,0,0], 16:[3,1,1,1,1,1,3,3,0,0,0,2,2,2,2,3], 15:[3,2,2,2,2,2,3,3,1,1,1,3,3,3,2,3], 14:[3,3,3,3,3,4,4,4,0,0,0,4,4,4,3,3], 13:[0,4,4,4,4,0,0,0,1,1,1,0,0,0,0,0], 12:[1,0,0,0,0,1,1,1,2,2,2,1,1,1,1,1], 11:[2,1,1,1,1,2,2,2,3,3,3,2,0,2,0,0], 10:[3,2,0,0,2,3,3,3,4,4,4,3,1,1,1,1], 9:[4,1,1,1,3,4,4,4,4,4,4,4,2,2,1,2], 8:[2,4,2,2,4,0,3,3,2,2,2,3,3,3,1,3], 7:[2,0,0,0,0,0,4,4,3,3,1,4,3,3,3,4], 6:[2,4,1,1,2,2,1,1,0,0,0,3,3,3,3,4], 5:[2,2,2,2,2,2,2,2,1,1,1,4,4,4,4,4], 4:[4,3,3,3,3,4,3,3,0,0,2,3,3,3,3,4], 3:[0,4,4,4,4,0,0,0,1,1,1,0,0,0,0,0], 2:[1,0,0,0,0,1,0,0,2,2,4,1,1,1,1,1], 1:[0,1,1,1,1,2,1,1,3,3,3,0,0,0,0,0] }
    };

    let selectedState = 'hazure';
    let selectedFlagIdx = 0;
    let selectedIdx = 1; // 1(Don)から開始
    const SH = window.innerHeight / 20;

    function setState(id) {
        document.querySelectorAll('.state-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('st-' + id).classList.add('active');
        selectedState = id;
    }

    function setFlag(id, idx) {
        document.querySelectorAll('.flag-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('f-' + id).classList.add('active');
        selectedFlagIdx = idx;
    }

    function execute() {
        const slip = DATA_SETS[selectedState][selectedIdx][selectedFlagIdx];
        let stopIdx = selectedIdx + slip;
        while (stopIdx > 21) stopIdx -= 21;
        document.getElementById('val-slip').innerText = slip;
        document.getElementById('val-pos').innerText = stopIdx;
        // 右リール：最終停止位置（中段）へ
        document.getElementById('strip-out').style.transform = `translateY(${-(21 + stopIdx - 4) * SH}px)`;
    }

    function createStrips() {
        ['strip-in', 'strip-out'].forEach(id => {
            const el = document.getElementById(id);
            // 3ループ分描画（吸着・無限スクロール風のため）
            for(let i=0; i<63; i++) {
                const symIdx = (i % 21) + 1;
                const d = document.createElement('div');
                d.className = 'symbol';
                // hanabi.png内の位置を正確に参照。1=ドン, 21=七。
                d.style.backgroundPosition = `0 ${(symIdx - 1) * 5}%`;
                el.appendChild(d);
            }
        });
        updateInReel();
    }

    function updateInReel() {
        // 中段を基準。配列の並びを正順(1->21)に。
        document.getElementById('strip-in').style.transform = `translateY(${-(21 + selectedIdx - 4) * SH}px)`;
        document.getElementById('val-target').innerText = selectedIdx;
    }

    const touchArea = document.getElementById('touch-area');
    let startY = 0, startIdx = 0;
    touchArea.addEventListener('touchstart', e => {
        startY = e.touches[0].pageY;
        startIdx = selectedIdx;
        touchArea.style.transition = 'none';
    });
    touchArea.addEventListener('touchmove', e => {
        let diff = e.touches[0].pageY - startY;
        let moveIdx = Math.round(diff / SH);
        let newIdx = startIdx - moveIdx;
        while(newIdx < 1) newIdx += 21;
        while(newIdx > 21) newIdx -= 21;
        if(newIdx !== selectedIdx) {
            selectedIdx = newIdx;
            updateInReel();
        }
    });
    touchArea.addEventListener('touchend', () => {
        // 指を離した瞬間に最寄りのコマへ吸着（既にmove内で補正済みだが念のため再更新）
        updateInReel();
    });

    window.onload = () => { createStrips(); };
</script>
</body>
</html>